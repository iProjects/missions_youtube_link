@model missions_youtube_links.UI.Web.Models.missions_view_model

@{
    ViewBag.Title = "Missions";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using (Html.BeginForm(null, null, FormMethod.Post, new { id = "frm_search" }))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true)

    <fieldset>

        <article>
            <div class="pad">

                <div class="form-group">
                    @Html.LabelFor(model => model.dto.mission_type, htmlAttributes: new { @class = "form-label" })
                    @Html.DropDownListFor(model => model.dto.mission_type, new SelectList(Model.dto.mission_types, "Value", "Text"), new { @class = "form-control", @id = "cbomission_types" })
                    @Html.ValidationMessageFor(model => model.dto.mission_type, "", new { @class = "lbl_error text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.dto.mission_year, htmlAttributes: new { @class = "form-label" })
                    @Html.DropDownListFor(model => model.dto.mission_year, new SelectList(Model.dto.mission_years, "Value", "Text"), new { @class = "form-control", @id = "cboyears" })
                    @Html.ValidationMessageFor(model => model.dto.mission_year, "", new { @class = "lbl_error text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.dto.mission_month, htmlAttributes: new { @class = "form-label" })
                    @Html.DropDownListFor(model => model.dto.mission_month, new SelectList(Model.dto.mission_months, "Value", "Text"), new { @class = "form-control", @id = "cbomonths" })
                    @Html.ValidationMessageFor(model => model.dto.mission_month, "", new { @class = "lbl_error text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.dto.mission_day, htmlAttributes: new { @class = "form-label" })
                    @Html.DropDownListFor(model => model.dto.mission_day, new SelectList(Model.dto.mission_days, "Value", "Text"), new { @class = "form-control", @id = "cbodays" })
                    @Html.ValidationMessageFor(model => model.dto.mission_day, "", new { @class = "lbl_error text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.dto.location, htmlAttributes: new { @class = "form-label" })
                    @Html.EditorFor(model => model.dto.location, new { htmlAttributes = new { @required = "required", @class = "form-control", @placeholder = "Location", @id = "txtlocation" } })
                    @Html.ValidationMessageFor(model => model.dto.location, "", new { @class = "lbl_error text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.dto.youtube_url, htmlAttributes: new { @class = "form-label" })
                    @Html.EditorFor(model => model.dto.youtube_url, new { htmlAttributes = new { @required = "required", @class = "form-control", @placeholder = "Youtube Url", @id = "txtyoutube_url" } })
                    @Html.ValidationMessageFor(model => model.dto.youtube_url, "", new { @class = "lbl_error text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.dto.description, htmlAttributes: new { @class = "form-label" })
                    @Html.EditorFor(model => model.dto.description, new { htmlAttributes = new { @required = "required", @class = "form-control", @placeholder = "Description", @id = "txtdescription" } })
                    @Html.ValidationMessageFor(model => model.dto.description, "", new { @class = "lbl_error text-danger" })
                </div>

            </div>
        </article>

        <div class="form-group div_btn">
            <input type="submit" value="Search" id="btnsearch" class="btn btn-success btn_class" />
            <input type="button" value="Clear Search" id="btn_clear_search" class="btn btn-danger btn_class" />
        </div>

    </fieldset>
}

<hr />

<h2 id="lbl_page_title">Missions [ @Model.lst_dto.ToList().Count  ]</h2>

<p>
    @Html.ActionLink("Create New", "Create", null, new { @class = "btn btn-primary btn_class", @id = "btn_create_record" })
    @Html.ActionLink("Delete All", "DeleteAll", null, new { @class = "btn btn-danger btn_class", @id = "btn_delete_all_records" })
</p>


<table class='table table-dark table-striped table-hover table-bordered table-sm table-success' id='tbl_persons'>
    <thead>
        <tr>
            <th width="40px">
                <input type="checkbox" name="chk_choose_all_records" id="chk_choose_all_records" />
            </th>
            <th width="40px">
                <span>ID</span>
            </th>
            <th>
                <span>URL</span>
            </th>
            <th width="150px">
                <span>DESCRIPTION</span>
            </th>
            <th width="100px">
                <span>LOCATION</span>
            </th>
            <th>
                <span>TYPE</span>
            </th>
            <th>
                <span>YEAR</span>
            </th>
            <th>
                <span>MONTH</span>
            </th>
            <th width="120px">
                <span>DATE</span>
            </th>
            <th>
                <span>DATE CREATED</span>
            </th>
            <th></th>
        </tr>
    </thead>

    <tbody id="tbody_records">

        @foreach (var item in Model.lst_dto)
        {
            <tr>
                <td>
                    <input type="checkbox" name="chk_record" class="chk_record" />
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.id)
                </td>
                <td class="bg-info">
                    <a href="@item.youtube_url" target="_blank" rel="noopener noreferrer" class="btn-link">@item.youtube_url</a>
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.description)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.location)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.mission_type)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.mission_year)
                </td>
                <td>
                    @(String.Format("{0}({1})", item.mission_month_str, item.mission_month))
                </td>
                <td>
                    @(String.Format("{0}({1})", item.mission_day_str, item.mission_day))
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.created_date)
                </td>
                <td>
                    @Html.ActionLink("Edit", "Edit", new { id = item.id }, new { @class = "btn_table btn btn-success", onclick = "return Edit(" + item.id + ")" })
                    @Html.ActionLink("Details", "Details", new { id = item.id }, new { @class = "btn_table btn btn-primary", onclick = "return Details(" + item.id + ")" })
                    @Html.ActionLink("Delete", "Delete", new { id = item.id }, new { @class = "btn_table btn btn-danger", onclick = "return Delete(" + item.id + ")" })
                </td>
            </tr>
        }

    </tbody>
</table>


<!-- delete Product Modal -->
<div class="modal fade" id="delete_product_modal" tabindex="-1" role="dialog" aria-labelledby="delete_product_Modal_Label">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="delete_product_Modal_Label">Delete Product</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div id="div_delete_modal_msg"></div>
                </div>

                <div class="form-group">
                    <label id="lbldeleteprompt"></label>
                    <input type="hidden" id="delete_product_hidden_id">
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" title="Delete" class="btn btn-primary" onclick="purge_product()"><img src="images/delete.png" title="Delete" style="vertical-align:bottom;" /> Delete</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<!-- // delete Product Modal -->

@section Scripts {

    <script type="text/javascript">

        $(document).ready(function () {

            document.getElementById('btn_clear_search').addEventListener('click', function (event) {
                event.preventDefault();
                clear_search();
                wire_checkboxes();
            });

            document.getElementById('btnsearch').addEventListener('click', function (event) {
                event.preventDefault();
                search();
                wire_checkboxes();
            });

            document.getElementById('cbomonths').addEventListener('change', function (event) {
                event.preventDefault();
                load_month_days();
            });

            var records_count = @Model.lst_dto.ToList().Count;
            $("#btn_missions").text(" Missions [" + records_count + "]");

            wire_checkboxes();
         
            function search() {
                try {

                    var mission_type = $("#cbomission_types").val();
                    var mission_year = $("#cboyears").val();
                    var mission_month = $("#cbomonths").val();
                    var mission_day = $("#cbodays").val();
                    var location = $("#txtlocation").val();
                    var description = $("#txtdescription").val();
                    var youtube_url = $("#txtyoutube_url").val();
                    $("#chk_choose_all_records").prop("checked", false);

                    $("#tbody_records").html("");

                    $.ajax({
                        url: '@Url.Action("search", "Missions")',
                        type: 'POST',
                        data: {
                            "mission_type": mission_type,
                            "mission_year": mission_year,
                            "mission_month": mission_month,
                            "mission_day": mission_day,
                            "location": location,
                            "description": description,
                            "youtube_url": youtube_url
                        },
                        success: function (data) {
                            console.log(data);
                            var links = data.lst_dto;
                            console.log(links);
                            var count = links.length;
                            console.log(count);
                            $("#btn_missions").text(" Missions [ " + count + " ]");
                            $("#lbl_page_title").text(" Missions [ " + count + " ]");
                            $("#tbody_records").html("");
                            var row = "";
                            $.each(links, function (index, item) {
                                row += "<tr>";
                                row += "<td><input type='checkbox' name=chk_record' class='chk_record' /></td>";
                                row += "<td>" + item.id + "</td>";
                                row += "<td><a href='" + item.youtube_url + "' target='_blank' rel='noopener noreferrer' class='btn-link'>" + item.youtube_url + "</a></td>";
                                row += "<td>" + item.description + "</td>";
                                row += "<td>" + item.location + "</td>";
                                row += "<td>" + item.mission_type + "</td>";
                                row += "<td>" + item.mission_year + "</td>";
                                row += "<td>" + item.mission_month_str + "(" + item.mission_month + ")" + "</td>";
                                row += "<td>" + item.mission_day_str + "(" + item.mission_day + ")" + "</td>";
                                row += "<td>" + item.created_date + "</td>";
                                row += "<td>";
                                row += "<a href='@Url.Action("Edit", "Missions", new { })'(" + item.id + ")' class='btn_table btn btn-success'>Edit</a>";
                                row += "<a href='@Url.Action("Detail", "Missions", new { })'(" + item.id + ")' class='btn_table btn btn-primary'>Detail</a>";
                                row += "<a href='@Url.Action("Delete", "Missions", new { })'(" + item.id + ")' class='btn_table btn btn-danger'>Delete</a>";
                                row += "</td>";
                                row += "</tr>";
                            });
                            $("#tbody_records").html(row);
                        }
                    });

                } catch (error) {
                    console.error(error);
                }
            }

            function clear_search() {
                try {

                    $("#cbomission_types").val(null);
                    $("#cboyears").val(null);
                    $("#cbomonths").val(null);
                    $("#cbodays").val(null);
                    $("#txtlocation").val("");
                    $("#txtdescription").val("");
                    $("#txtyoutube_url").val("");
                    $("#chk_choose_all_records").prop("checked", false);

                    var mission_type = $("#cbomission_types").val();
                    var mission_year = $("#cboyears").val();
                    var mission_month = $("#cbomonths").val();
                    var mission_day = $("#cbodays").val();
                    var location = $("#txtlocation").val();
                    var description = $("#txtdescription").val();
                    var youtube_url = $("#txtyoutube_url").val();

                    $("#tbody_records").html("");

                    $.ajax({
                        url: '@Url.Action("search", "Missions")',
                        type: 'POST',
                        data: {
                            "mission_type": mission_type,
                            "mission_year": mission_year,
                            "mission_month": mission_month,
                            "mission_day": mission_day,
                            "location": location,
                            "description": description,
                            "youtube_url": youtube_url
                        },
                        success: function (data) {
                            console.log(data);
                            var links = data.lst_dto;
                            console.log(links);
                            var count = links.length;
                            console.log(count);
                            $("#btn_missions").text(" Missions [ " + count + " ]");
                            $("#lbl_page_title").text(" Missions [ " + count + " ]");
                            $("#tbody_records").html("");
                            var row = "";
                            $.each(links, function (index, item) {
                                row += "<tr>";
                                row += "<td><input type='checkbox'  name=chk_record' class='chk_record' /></td>";
                                row += "<td>" + item.id + "</td>";
                                row += "<td><a href='" + item.youtube_url + "' target='_blank' rel='noopener noreferrer' class='btn-link'>" + item.youtube_url + "</a></td>";
                                row += "<td>" + item.description + "</td>";
                                row += "<td>" + item.location + "</td>";
                                row += "<td>" + item.mission_type + "</td>";
                                row += "<td>" + item.mission_year + "</td>";
                                row += "<td>" + item.mission_month_str + "(" + item.mission_month + ")" + "</td>";
                                row += "<td>" + item.mission_day_str + "(" + item.mission_day + ")" + "</td>";
                                row += "<td>" + item.created_date + "</td>";
                                row += "<td>";
                                row += "<a href='@Url.Action("Edit", "Missions", new { })'(" + item.id + ")' class='btn_table btn btn-success'>Edit</a>";
                                row += "<a href='@Url.Action("Detail", "Missions", new { })'(" + item.id + ")' class='btn_table btn btn-primary'>Detail</a>";
                                row += "<a href='@Url.Action("Delete", "Missions", new { })'(" + item.id + ")' class='btn_table btn btn-danger'>Delete</a>";
                                row += "</td>";
                                row += "</tr>";
                            });
                            $("#tbody_records").html(row);
                        }
                    });

                } catch (error) {
                    console.error(error);
                }
            }

            function wire_checkboxes() {
                //select all checkboxes
                $("#chk_choose_all_records").on("click", function () {
                    var chk_status = this.checked;
                    //iterate all checkbox items
                    $(".chk_record").each(function () {
                        this.checked = chk_status;
                    });
                });

                //check or uncheck selectall, if one of the listed checkbox items is checked/unchecked
                $(".chk_record").on("click", function () {
                    if ($(".chk_record:checked").length == $(".chk_record").length) {
                        $("#chk_choose_all_records").prop("checked", true);
                    } else {
                        $("#chk_choose_all_records").prop("checked", false);
                    }
                });
            }

            function load_month_days() {
                var selectedyear = $("#cboyears").val();
                var selectedmonth = $("#cbomonths").val();
                var cbodays = $("#cbodays");

                console.log(selectedyear);
                console.log(selectedmonth);

                if (selectedyear == '' && selectedmonth == '') {
                    var my_val = $("#cbodays option:first").val();
                    $("#cbodays").val("");
                    return;
                }

                $.getJSON('@Url.Action("getmonthdays", "Missions")',
                    {
                        year: selectedyear,
                        month: selectedmonth
                    }, function (days) {
                        console.log(days);
                        if (days != null && !jQuery.isEmptyObject(days)) {
                            cbodays.empty();
                            cbodays.append($('<option/>', {
                                value: "",
                                text: "--- Select Day ---"
                            }))
                            $.each(days, function (index, day) {
                                console.log(day);
                                console.log(index);
                                cbodays.append($('<option/>', {
                                    value: day.Value,
                                    text: day.Text
                                }))
                            })
                        }
                        var my_val = $("#cbodays option:last").val();
                        $("#cbodays").val(my_val);
                    });
            }


            //Delete Record
            function Delete(id) {

                showprogressbar();

                var _prompt_msg = "<span class='text-danger'>Are you sure, you really want to delete product with id [ " + id + " ]</span>";

                $("#lbldeleteprompt").html(_prompt_msg);

                // Open modal popup
                $("#delete_product_modal").modal("show");

                $('#delete_product_modal').on('shown.bs.modal', function (e) {

                    $('#btndeleteproduct').on('click', function () {
                        purge_product();
                    });

                });

                hideprogressbar();

            }

            //Delete Record
            function purge_product() {
                showprogressbar();

                // get hidden field value
                var id = $("#delete_product_hidden_id").val();

                $.ajax({
                    type: 'POST',
                    url: 'delete_product_controller.php',
                    data: {
                        id: id
                    } //data to be posted
                }).done(function (data) {

                    log_messages_modal(data);

                    // hide modal popup
                    $("#delete_product_modal").modal("hide");

                    log_messages(data);

                    // reload products by using readRecords();
                    //readRecords();
                    get_admin_products(1);

                }).fail(function (jqXHR, textStatus) {
                    log_messages_modal(textStatus);
                    hideprogressbar();
                });

            }


        });


    </script>
}








